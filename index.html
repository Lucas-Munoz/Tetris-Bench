<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tetris Bench</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>
</head>
<body>
    <script src="Tablero.js"></script>
    <script src="Tetrimino.js"></script>
    <script>
        const margin_tablero = 15
        let speed_regulator = 0
        function setup(){
            createCanvas(900,600)
            tablero = new TableroT()
            createMapBaseTetriminos()
            tetrimino = new Tetrimino()
            resizeCanvas(
                tablero.ancho + 2*margin_tablero,
                tablero.alto + 2*margin_tablero + tablero.lado
            )
        }
        function draw(){
            background("#17a7a8")
            tablero.dibujar()
            tetrimino.dibujar()
            keyEventTetris()
        }

        function keyEventTetris(){
            if (millis()-speed_regulator < 150){
                return
            }
            speed_regulator = millis()

            if (keyIsDown(RIGHT_ARROW)){
               tetrimino.rightMov()
            }
            if (keyIsDown(LEFT_ARROW)){
                tetrimino.leftMov()
            }     
            if (keyIsDown(UP_ARROW)){
                tetrimino.girar
            }
            if (keyIsDown(DOWN_ARROW)){
                tetrimino.downMov()
            }     
        }
       
        class Tetrimino{
            constructor(nombre = "Z"){
                this.nombre = nombre
                let tetriminoBase = tetriminosBase[nombre]
                this.color = tetriminoBase.color
                this.map = []
                for (const pmino of tetriminoBase.map){
                    this.map.push(pmino.copy())
                }
                this.posicion = createVector(int(tablero.columnas / 2),0)
            }
            rightMov(){
                this.posicion.x++
                if(this.failMovement){
                    this.leftMov()
                }
            }
            leftMov(){
                this.posicion.x--
                if(this.failMovement){
                    this.rightMov()
                }
            }

            downMov(){
                this.posicion.y++
                if(this.failMovement){
                    this.upMov()
                }
            }

            upMov(){
                this.posicion.y--
            }
            
            girar(){
                for (const pmino of this.mapa){
                    pmino.set(pmino.y,-pmino.x)
                }
                if(this.failMovement){
                    this.desgirar()
                }
            }

            desgirar(){
                for (const pmino of this.mapa){
                    pmino.set(-pmino.y,pmino.x)
                }
            }

            get failMovement(){
                let outTablero = !this.isonTablero;
                return outTablero
            }

            get isonTablero(){
                for (const pmino of this.mapTablero){
                    if (pmino.x < 0){
                        return false
                    }
                    if (pmino.x >= tablero.columnas){
                        return false
                    }
                    if (pmino.x >= tablero.columnas){
                        return false
                    }
                }
                return true
            }

            get mapTablero(){
                let retorno = []
                for(const pmino of this.map){
                    let copy = pmino.copy().add(this.posicion)
                    retorno.push(copy);
                }
                return retorno
            }

            get mapCanvas(){
                let retorno = []
                for(const pmino of this.map){
                    let copy = pmino.copy().add(this.posicion)
                    retorno.push (tablero.coordenada(copy.x, copy.y));
                }
                return retorno
            }

            dibujar(){
                push()
                fill(this.color)
                for (const pmino of this.mapTablero){
                    let coord = tablero.coordenada(pmino.x, pmino.y)
                    rect(pmino.x, pmino.y, tablero.lado)
                    push()
                    noStroke()
                    fill(255,255,255,70)
                    beginShape()
                    vertex(pmino.x, pmino.y)
                    vertex(pmino.x, pmino.y+this.lado)
                    vertex(pmino.x+this.lado, pmino.y)
                    endShape(CLOSE)
                    rect(pmino.x, pmino.y, tablero.lado,tablero.lado/2)
                    pop()
                }
                pop()
            }
        }
    </script>
</body>
</html>